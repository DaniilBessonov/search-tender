<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Результаты расширенного поиска</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="NOINDEX, NOFOLLOW">
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript"> (function (d, w, c) {
        (w[c] = w[c] || []).push(function () {
            try {
                w.yaCounter33913164 = new Ya.Metrika({ id: 33913164, clickmap: true, trackLinks: true, accurateTrackBounce: true, webvisor: true, ut: "noindex" });
            } catch (e) {
            }
        });
        var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () {
            n.parentNode.insertBefore(s, n);
        };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";
        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else {
            f();
        }
    })(document, window, "yandex_metrika_callbacks");</script>
    <noscript>
        <div><img src="https://mc.yandex.ru/watch/33913164?ut=noindex" style="position:absolute; left:-9999px;" alt=""/>
        </div>
    </noscript>
    <!-- /Yandex.Metrika counter -->


    <link href="http://www.zakupki.gov.ru/epz/order/extendedsearch/images/icons/Portal.ico" rel="shortcut icon">
    <link type="text/css" rel="stylesheet" media="all" href="./index_files/style.css">

    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-datepicker.min.css">


    <style type="text/css">

        .main-container {
            padding-right: 20px;
            padding-left: 20px;
            display: block;
        }

        .progress {
            margin-bottom: 10px;
            margin-top: 10px;
        }

        .btn {
            float: none;
        }

        button {
            margin-right: 10px;
        }

        #items-container {
            padding-top: 20px;
            font: normal 14px Tahoma, Geneva, sans-serif;
        }

        #results-info {
            margin: 10px 0;
        }

        .registerBox {
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 1px 10px rgba(17, 78, 109, 0.5);
        }

        #data-container .input-group {
            max-width: 250px;
        }
    </style>

</head>
<body>
<div class="main-container">

    <h2>Фильтры для поиска заказов</h2>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Регионы поиска</h3>
        </div>
        <div id="regions-container" class="panel-body">
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277321" checked>
                    Воронежская обл
                </label>
            </div>

            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277325">
                    Курская обл
                </label>
            </div>

            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277326">
                    Липецкая обл
                </label>
            </div>

            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277331">
                    Тамбовская обл
                </label>
            </div>

            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277318">
                    Белгородская обл
                </label>
            </div>

        </div>
    </div>


    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Слова для поиска</h3>
        </div>
        <div id="keywords-container" class="panel-body">
            <!-- <div class="row">
                 <div class="col-xs-6 col-sm-3 col-md-3">
                     <div class="checkbox">
                         <label>
                             <input type="checkbox" value="видеонаблюдение" checked>
                             видеонаблюдение
                         </label>

                     </div>
                 </div>
                 <div class="col-xs-6 col-sm-9 col-md-9">
                     <div class="progress">
                         <div id="pb-видеонаблюдение" class="progress-bar" role="progressbar" style="width: 20%;"></div>
                     </div>
                 </div>
             </div>-->


        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Даты публикации и изменения заказов</h3>
        </div>
        <div id="data-container" class="panel-body row">
            <div class="col-xs-12 col-sm-12 col-md-6">
                <h4>Дата публикации заказа</h4>

                <div class="input-group">
                    <input id="orderPublishDateFrom" type="text" class="form-control" placeholder="дата">
                  <span class="input-group-btn">
                    <button class="btn btn-default btn-data-picker" type="button">Указать дату</button>
                  </span>
                </div>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-6">
                <h4>Дата изменения заказа</h4>

                <div class="input-group">
                    <input id="orderUpdateDateFrom" type="text" class="form-control" placeholder="дата">
                  <span class="input-group-btn">
                    <button class="btn btn-default btn-data-picker" type="button">Указать дату</button>
                  </span>
                </div>
            </div>
        </div>
    </div>

    <div class="panel panel-default">

        <div class="panel-body">
            <div>
                <button id="startSearch" class="btn btn-primary" onclick="startSearch()">Запустить поиск</button>
                <button id="removeResults" class="btn btn-default" onclick="removeSearchResults()">Очистить результаты
                    поиска
                </button>
                <!--<button class="btn btn-default disabled" onclick="">Отправить результаты на почту</button>-->
            </div>
            <div id="results-info">
                <h3>Статус поиска: <span id="search-status" class="label label-primary">Готов к запуску поиска</span>
                </h3>

                <p>Количество найденных результатов: <span id="full-items-count" class="badge">0</span></p>
            </div>
        </div>
    </div>


    <h2>Результаты поиска закупок и заказов</h2>


    <div id="items-container">


    </div>
</div>


<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/engine.js"></script>
<script type="text/javascript" src="js/bootstrap-datepicker.min.js"></script>
<script type="text/javascript" src="js/bootstrap-datepicker.ru.min.js"></script>

<script type="text/javascript">
    if (typeof console == "undefined") {
        this.console = {log: function () {
        }};
    }

    var se = new SearchEngine();

    $(document).ready(function () {
        generateKeywordsContainers();
        //$("#keywords-container input[type='checkbox']:checked").prop("checked", false)
        initDataPicker();
    });

    var g_keywords = [
        'сигнализация',
        'охранно-пожарной сигнализации',
        'ОПС',
        'охранной сигнализации',
        'пожарной сигнализации',
        'противопожарной защиты',

        'систем оповещения',
        'звукового оповещения',
        'тревожной сигнализации',
        'контроля доступом',
        'СКУД',
        'управления доступом',
        'КПП',
        'проходная',
        'турникет',

        'видеонаблюдение',
        'видеокамеры'];

    function initDataPicker() {
        var dataPicker = $('.btn-data-picker');
        dataPicker.datepicker({
            format: "yyyy-mm-dd",
            language: "ru",
            autoclose: true,
            todayHighlight: true
        });
        dataPicker.datepicker().on('changeDate', function (e) {
            //console.log(e.currentTarget, e.date.trueFormat());
            $(e.currentTarget).parent().prev().val(e.date.trueFormat());
        });
    }

    function startSearch() {
        $(document).ready(function () {
            var keywords = getKeywordsForSearch();
            var regions = getRegionsForSearch();
            if (keywords.length == 0 || regions.length == 0) {
                alert("Ошибка. Не выбраны параметры для поиска!");
            } else {
                showProgressStatus();
                disableControls();
                setDatesForSearch();
                se.findItemsForKeywords(keywords, regions).done(function () {
                    removeDuplicates();
                    showFinishStatus();
                    enableControls();
                    console.log("FINISH");
                });
            }
        });
    }

    function disableControls() {
        $("button").addClass("disabled");
        $("input[type=checkbox]").prop('disabled', true);
    }

    function enableControls() {
        $("button").removeClass("disabled");
        $("input[type=checkbox]").prop('disabled', false);
    }

    function showProgressStatus() {
        $("#search-status").html("Идет поиск").removeClass("label-primary").removeClass("label-success").addClass("label-danger");
    }

    function showFinishStatus() {
        $("#search-status").html("Поиск завершен").removeClass("label-primary").removeClass("label-danger").addClass("label-success");
    }

    function removeSearchResults() {
        var el = $("#items-container");
        el.children().remove();
        se.refreshResultsCount();
        //el.append("<p>Нет результатов поиска</p>");
    }

    function getKeywordsForSearch() {
        var result = [];
        var checkBoxes = $("#keywords-container input[type='checkbox']:checked");
        $.each(checkBoxes, function (i, chBox) {
            result.push($(chBox).attr('value'));
        });
        //console.log(result);
        return result;
    }

    function getRegionsForSearch() {
        var result = [];
        var checkBoxes = $("#regions-container input[type='checkbox']:checked");
        $.each(checkBoxes, function (i, chBox) {
            result.push($(chBox).attr('value'));
        });
        //console.log(result);
        return result;
    }

    function setDatesForSearch() {
        se.orderPublishDateFrom = $("#orderPublishDateFrom").val();
        se.orderUpdateDateFrom = $("#orderUpdateDateFrom").val();
    }

    function generateKeywordsContainers() {
        $.each(g_keywords, function (i, key) {
            generateKeywordContainer(key);
        });
    }

    function generateKeywordContainer(keyword) {
        var keywordWithoutSpace = se.getWordWithoutSpaces(keyword);

        var htmlTemplate = '<div class="row"><div class="col-xs-6 col-sm-3 col-md-3"><div class="checkbox"><label><input type="checkbox" value="obj.keyword" checked>obj.keyword</label></div></div><div class="col-xs-6 col-sm-9 col-md-9"><div class="progress" style="display:none"><div id="pb-obj.keywordWithoutSpaces" class="progress-bar" role="progressbar" style="width: 0%;"></div></div></div></div>';
        var html = convertStrToHTML("keywordWithoutSpaces", keywordWithoutSpace, htmlTemplate);
        html = convertStrToHTML("keyword", keyword, html);
        $("#keywords-container").append(html);
    }

    function getWordWithoutSpaces(keyword) {
        return keyword.replace(new RegExp(" ", 'g'), "_");
    }

    function convertJsToHTML(obj, str) {
        for (var prop in obj) {
            var find = 'obj.' + prop;
            var re = new RegExp(find, 'g');
            str = str.replace(re, obj[prop]);
        }
        return str;
    }

    function convertStrToHTML(key, val, str) {
        var find = 'obj.' + key;
        var re = new RegExp(find, 'g');
        str = str.replace(re, val);
        return str;
    }

    function removeDuplicates() {
        var ids = [];
        var arrElements = $("#items-container .descriptTenderTd dt a");
        $.each(arrElements, function (i, item) {
            var str = $(item).html();
            var regexp = new RegExp('[0-9]+', '');
            var id = regexp.exec(str)[0];
            ids.push(id);
            //console.log($("#" + id));
            $("#" + id).remove();
            $(item).parents(".registerBox").attr("id", id);
        });
        se.refreshResultsCount();

        /*console.log(ids);
         console.log($.unique(ids));
         for (var i = 0; i < ids.length; i++) {
         for (var j = i + 1; j < ids.length; j++) {
         if (ids[i] == ids[j]) {
         $("#" + ids[i])
         }
         }
         }*/
    }

    Date.prototype.trueFormat = function () {
        var yyyy = this.getFullYear().toString();
        var mm = (this.getMonth() + 1).toString(); // getMonth() is zero-based
        var dd = this.getDate().toString();
        return (dd[1] ? dd : "0" + dd[0]) + '.' + (mm[1] ? mm : "0" + mm[0]) + '.' + yyyy; // padding
    };
</script>
</body>
</html>
