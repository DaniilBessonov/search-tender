<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Результаты расширенного поиска</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="NOINDEX, NOFOLLOW">
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript"> (function (d, w, c) {
        (w[c] = w[c] || []).push(function () {
            try {
                w.yaCounter33913164 = new Ya.Metrika({ id: 33913164, clickmap: true, trackLinks: true, accurateTrackBounce: true, webvisor: true, ut: "noindex" });
            } catch (e) {
            }
        });
        var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () {
            n.parentNode.insertBefore(s, n);
        };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";
        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else {
            f();
        }
    })(document, window, "yandex_metrika_callbacks");</script>
    <noscript>
        <div><img src="https://mc.yandex.ru/watch/33913164?ut=noindex" style="position:absolute; left:-9999px;" alt=""/>
        </div>
    </noscript>
    <!-- /Yandex.Metrika counter -->


    <link href="http://www.zakupki.gov.ru/epz/order/extendedsearch/images/icons/Portal.ico" rel="shortcut icon">
    <link type="text/css" rel="stylesheet" media="all" href="./index_files/style.css">

    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-datepicker.min.css">


    <style type="text/css">

        .main-container {
            padding-right: 20px;
            padding-left: 20px;
            display: block;
        }

        .progress {
            margin-bottom: 10px;
            margin-top: 10px;
        }

        .btn {
            float: none;
        }

        #items-container {
            padding-top: 20px;
            font: normal 14px Tahoma, Geneva, sans-serif;
        }

        #results-info {
            margin: 10px 0;
        }

        .registerBox {
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 1px 10px rgba(17, 78, 109, 0.5);
        }

        #data-container .input-group {
            max-width: 420px;
            margin-top: 10px;
        }

        #price-container .input-group {
            max-width: 500px;
        }

        #data-container .input-group > span {
            min-width: 107px;
        }

        .ignore-btn {
            margin-top: 10px;
        }

        .btn-remove-keyword {
            float: right;
            display: none;
        }

        #keywords-container .row:hover .btn-remove-keyword {
            opacity: 0.2;
            display: block;
        }

        #keywords-container .row .btn-remove-keyword:hover {
            opacity: 1;
        }
    </style>

</head>
<body>
<div class="main-container">

<h2>Фильтры для поиска заказов</h2>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Регионы поиска</h3>
    </div>
    <div id="regions-container" class="panel-body row">
        <div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277321" checked>
                    Воронежская обл
                </label>
            </div>

            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277318">
                    Белгородская обл
                </label>
            </div>

            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277325">
                    Курская обл
                </label>
            </div>

            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277326">
                    Липецкая обл
                </label>
            </div>

            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277327">
                    Московская обл
                </label>
            </div>

            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277331">
                    Тамбовская обл
                </label>
            </div>

        </div>

        <div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277335">
                    Город Москва
                </label>
            </div>
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277319">
                    Брянская обл
                </label>
            </div>
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277320">
                    Владимирская обл
                </label>
            </div>
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277322">
                    Ивановская обл
                </label>
            </div>
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277323">
                    Калужская обл
                </label>
            </div>
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277324">
                    Костромская обл
                </label>
            </div>

        </div>
        <div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277328">
                    Орловская обл
                </label>
            </div>
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277329">
                    Рязанская обл
                </label>
            </div>
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277330">
                    Смоленская обл
                </label>
            </div>
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277332">
                    Тверская обл
                </label>
            </div>
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277333">
                    Тульская обл
                </label>
            </div>
            <div class="checkbox ">
                <label>
                    <input type="checkbox" value="5277334">
                    Ярославская обл
                </label>
            </div>

        </div>
    </div>
</div>


<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Слова для поиска</h3>
    </div>
    <div class="panel-body">
        <div id="keywords-container">
            <!-- <div class="row">
                 <div class="col-xs-6 col-sm-5 col-md-5">
                     <div class="checkbox">
                         <label>
                             <input type="checkbox" value="видеонаблюдение" checked>
                             видеонаблюдение
                         </label>

                         <button type="button" class="btn btn-danger btn-sm btn-remove-keyword"
                                 onclick="removeKeyword(this)"><span
                                 class="glyphicon glyphicon-remove" aria-hidden="true"></span> Удалить
                         </button>
                     </div>
                 </div>
                 <div class="col-xs-6 col-sm-7 col-md-7">
                     <div class="progress">
                         <div id="pb-видеонаблюдение" class="progress-bar" role="progressbar" style="width: 20%;"></div>
                     </div>
                 </div>
             </div>-->
        </div>
        <div class="input-group" style="margin-top: 10px">
            <input id="keyword-input" type="text" class="form-control" placeholder="поисковый запрос">
            <span class="input-group-btn">
              <button class="btn btn-default" type="button" onclick="addKeyword()">Добавить</button>
            </span>
        </div>
    </div>
</div>
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Даты публикации и изменения заказов</h3>
    </div>
    <div id="data-container" class="panel-body row">
        <div class="col-xs-12 col-sm-12 col-md-6">
            <h4>Дата публикации заказа</h4>

            <div class="input-group">
                <span class="input-group-addon">Дата начала</span>
                <input id="orderPublishDateFrom" type="text" class="form-control" placeholder="дата">

                <div class="input-group-btn">
                    <button type="button" class="btn btn-default" onclick="$(this).parent().prev().val('')">Очистить
                        <span class="glyphicon glyphicon-remove"></span></button>
                    <button class="btn btn-default btn-data-picker" type="button">Указать дату</button>
                </div>
            </div>

            <div class="input-group">
                <span class="input-group-addon">Дата конца</span>
                <input id="orderPublishDateTo" type="text" class="form-control" placeholder="дата">

                <div class="input-group-btn">
                    <button type="button" class="btn btn-default" onclick="$(this).parent().prev().val('')">Очистить
                        <span class="glyphicon glyphicon-remove"></span></button>
                    <button class="btn btn-default btn-data-picker" type="button">Указать дату</button>
                </div>
            </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-6">
            <h4>Дата изменения заказа</h4>

            <div class="input-group">
                <span class="input-group-addon">Дата начала</span>
                <input id="orderUpdateDateFrom" type="text" class="form-control" placeholder="дата">

                <div class="input-group-btn">
                    <button type="button" class="btn btn-default" onclick="$(this).parent().prev().val('')">Очистить
                        <span class="glyphicon glyphicon-remove"></span></button>
                    <button class="btn btn-default btn-data-picker" type="button">Указать дату</button>
                </div>
            </div>
            <div class="input-group">
                <span class="input-group-addon">Дата конца</span>
                <input id="orderUpdateDateTo" type="text" class="form-control" placeholder="дата">

                <div class="input-group-btn">
                    <button type="button" class="btn btn-default" onclick="$(this).parent().prev().val('')">Очистить
                        <span class="glyphicon glyphicon-remove"></span></button>
                    <button class="btn btn-default btn-data-picker" type="button">Указать дату</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Диапазон цены аукциона</h3>
    </div>
    <div id="price-container" class="panel-body">
        <h4>Цена заказа</h4>
        <div class="input-group">
            <span class="input-group-addon">От</span>
            <input id="orderPriceFrom" type="number" class="form-control" placeholder="Минимальная цена">
            <span class="input-group-addon">До</span>
            <input id="orderPriceTo" type="number" class="form-control" placeholder="Максимальная цена">
            <span class="input-group-addon">Руб</span>
        </div>
    </div>
</div>

<div class="panel panel-default">

    <div class="panel-body">
        <div>
            <button id="startSearch" class="btn btn-primary" onclick="startSearch()">Запустить поиск</button>
            <button id="removeResults" class="btn btn-default" onclick="removeSearchResults()">Очистить результаты
                поиска
            </button>
            <!--<button class="btn btn-default disabled" onclick="">Отправить результаты на почту</button>-->
        </div>
        <div id="results-info">
            <h3>Статус поиска: <span id="search-status" class="label label-primary">Готов к запуску поиска</span>
            </h3>

            <p>Количество найденных результатов: <span id="full-items-count" class="badge">0</span></p>
        </div>
    </div>
</div>


<h2>Результаты поиска закупок и заказов</h2>


<div id="items-container">


</div>
</div>


<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/engine.js"></script>
<script type="text/javascript" src="js/bootstrap-datepicker.min.js"></script>
<script type="text/javascript" src="js/bootstrap-datepicker.ru.min.js"></script>

<script type="text/javascript">
if (typeof console == "undefined") {
    this.console = {log: function () {
    }};
}

var se = new SearchEngine();
var db = new DBEngine();
var g_keywords = [
    'сигнализация',
    'охранно-пожарной сигнализации',
    'ОПС',
    'охранной сигнализации',
    'пожарной сигнализации',
    'противопожарной защиты',

    'систем оповещения',
    'звукового оповещения',
    'тревожной сигнализации',
    'контроля доступом',
    'СКУД',
    'управления доступом',
    'КПП',
    'проходная',
    'турникет',

    'видеонаблюдение',
    'видеокамеры'];


$(document).ready(function () {
    generateKeywordsContainers();
    $("#keywords-container input[type='checkbox']:checked").prop("checked", false); //TODO for tests
    initDataPicker();
    setTodayDate();
});

function initDataPicker() {
    var dataPicker = $('.btn-data-picker');
    dataPicker.datepicker({
        format: "dd.mm.yyyy",
        language: "ru",
        autoclose: true,
        todayHighlight: true
    });
    dataPicker.datepicker().on('changeDate', function (e) {
        //console.log(e.currentTarget, e.date.trueFormat());
        $(e.currentTarget).parent().prev().val(e.date.trueFormat());
    });
}

function startSearch() {
    $(document).ready(function () {
        var keywords = getKeywordsForSearch();
        var regions = getRegionsForSearch();
        if (keywords.length == 0 || regions.length == 0) {
            alert("Ошибка. Не выбраны параметры для поиска!");
        } else {
            $("#items-container").children().remove();
            showProgressStatus();
            disableControls();
            setOptionalParams();
            se.findItemsForKeywords(keywords, regions).done(function () {
                removeDuplicates();
                removeIgnored().done(function () {
                    generateIgnoreButtons();
                    se.refreshResultsCount();
                    showFinishStatus();
                    enableControls();
                    console.log("FINISH");
                });
            });
        }
    });
}

function disableControls() {
    $("button").addClass("disabled");
    $("input[type=checkbox]").prop('disabled', true);
}

function enableControls() {
    $("button").removeClass("disabled");
    $("input[type=checkbox]").prop('disabled', false);
}

function showProgressStatus() {
    $("#search-status").html("Идет поиск").removeClass("label-primary").removeClass("label-success").addClass("label-danger");
}

function showFinishStatus() {
    $("#search-status").html("Поиск завершен").removeClass("label-primary").removeClass("label-danger").addClass("label-success");
}

function removeSearchResults() {
    var el = $("#items-container");
    el.children().remove();
    se.refreshResultsCount();
    //el.append("<p>Нет результатов поиска</p>");
}

function getKeywordsForSearch() {
    var result = [];
    var checkBoxes = $("#keywords-container input[type='checkbox']:checked");
    $.each(checkBoxes, function (i, chBox) {
        result.push($(chBox).attr('value'));
    });
    //console.log(result);
    return result;
}

function getRegionsForSearch() {
    var result = [];
    var checkBoxes = $("#regions-container input[type='checkbox']:checked");
    $.each(checkBoxes, function (i, chBox) {
        result.push($(chBox).attr('value'));
    });
    //console.log(result);
    return result;
}

function setOptionalParams() {
    se.optionalParams = {
        orderPublishDateFrom: $("#orderPublishDateFrom").val(),
        orderUpdateDateFrom: $("#orderUpdateDateFrom").val(),
        orderPublishDateTo: $("#orderPublishDateTo").val(),
        orderUpdateDateTo: $("#orderUpdateDateTo").val(),
        orderPriceFrom: $("#orderPriceFrom").val(),
        orderPriceTo: $("#orderPriceTo").val()
    };
    //console.log("Optional params:", se.optionalParams);
}

function generateKeywordsContainers() {
    $.each(g_keywords, function (i, key) {
        generateKeywordContainer(key);
    });
    db.getKeywords().done(function (keywords) {
        $.each(keywords, function (i, key) {
            generateKeywordContainer(key);
        });
    });
}

function generateKeywordContainer(keyword) {
    var keywordWithoutSpace = se.getWordWithoutSpaces(keyword);

    var htmlTemplate = '<div class="row"><div class="col-xs-6 col-sm-5 col-md-5"><div class="checkbox"><label><input type="checkbox" value="obj.keyword" checked>obj.keyword</label><button type="button" class="btn btn-danger btn-sm btn-remove-keyword" onclick="removeKeyword(this)"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Удалить навсегда</button></div></div><div class="col-xs-6 col-sm-7 col-md-7"><div class="progress" style="display:none"><div id="pb-obj.keywordWithoutSpaces" class="progress-bar" role="progressbar" style="width: 0%;"></div></div></div></div>';
    var html = convertStrToHTML("keywordWithoutSpaces", keywordWithoutSpace, htmlTemplate);
    html = convertStrToHTML("keyword", keyword, html);
    $("#keywords-container").append(html);
}

function getWordWithoutSpaces(keyword) {
    return keyword.replace(new RegExp(" ", 'g'), "_");
}

function convertJsToHTML(obj, str) {
    for (var prop in obj) {
        var find = 'obj.' + prop;
        var re = new RegExp(find, 'g');
        str = str.replace(re, obj[prop]);
    }
    return str;
}

function convertStrToHTML(key, val, str) {
    var find = 'obj.' + key;
    var re = new RegExp(find, 'g');
    str = str.replace(re, val);
    return str;
}

function removeDuplicates() {
    var ids = [];
    var arrElements = $("#items-container .descriptTenderTd dt a");
    $.each(arrElements, function (i, item) {
        var str = $(item).html();
        var regexp = new RegExp('[0-9]+', '');
        var id = regexp.exec(str)[0];
        ids.push(id);
        //console.log($("#" + id));
        $("#" + id).remove();
        $(item).parents(".registerBox").attr("id", id);
    });
    se.refreshResultsCount();
}

function generateIgnoreButtons() {
    var html = '<dd><button class="btn btn-danger ignore-btn" onclick="addToIgnoreList(this)">не показывать больше</button></dd>';
    $("#items-container .amountTenderTd dl").append(html);
}

function addToIgnoreList(el) {
    var id = $(el).parents(".registerBox").css("opacity", 0.3).attr("id");
    console.log("Add to ignore id=" + id);
    db.addToIgnoreList(id).done(function (res) {
        console.log("Added to ignore id=" + id, res);
    });
    $(el).attr("onclick", "removeFromIgnoreList(this)").html("показывать");
}

function removeFromIgnoreList(el) {
    var id = $(el).parents(".registerBox").css("opacity", 1).attr("id");
    console.log("Remove from ignore id=" + id);
    db.removeFromIgnoreList(id).done(function (res) {
        console.log("Removed from ignore id=" + id, res);
    });
    $(el).attr("onclick", "addToIgnoreList(this)").html("не показывать больше");
}

function removeIgnored() {
    return db.getIgnoreList().done(function (res) {
        $("#" + res.join(", #")).remove();
    });
}

function addKeyword() {
    var inputEl = $("#keyword-input");
    var key = inputEl.val();
    if (key != "") {
        db.addKeyword(key);
        generateKeywordContainer(key);
        inputEl.val("");
    }else{
        alert("Введите поисковый запрос");
    }
}

function removeKeyword(el) {
    var inp = $(el).prev().children("input");
    db.removeKeyword(inp.val());
    inp.parents(".row").remove();
}

function setTodayDate() {
    var today = new Date();
    $("#orderPublishDateFrom, #orderUpdateDateFrom").val(today.trueFormat());
}
Date.prototype.trueFormat = function () {
    var yyyy = this.getFullYear().toString();
    var mm = (this.getMonth() + 1).toString(); // getMonth() is zero-based
    var dd = this.getDate().toString();
    return (dd[1] ? dd : "0" + dd[0]) + '.' + (mm[1] ? mm : "0" + mm[0]) + '.' + yyyy; // padding
};
</script>
</body>
</html>
